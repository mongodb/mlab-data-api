functions:
  "fetch source":
    - command: git.get_project
      params:
        directory: mlab-data-api/src
  "run tests":
    - command: subprocess.exec
      params:
        working_dir: mlab-data-api/src
        env:
          JAVA_HOME: /opt/java/jdk11
          MLAB_DATA_API_TEST_PROD_KEY: ${MLAB_DATA_API_TEST_PROD_KEY}
          MLAB_DATA_API_TEST_CONFIG: ${MLAB_DATA_API_TEST_CONFIG}
        binary: ./gradlew
        args:
          - install
          - test
  "build docker image":
    - command: subprocess.exec
      params:
        working_dir: mlab-data-api/src
        binary: docker
        args:
          - build
          - -t
          - mlab-data-api
          - .
  "login to ecr":
    - command: shell.exec
      params:
        script: |
          export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
          export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
          aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${AWS_ECR_DOCKER_TAG}
  "tag docker image":
    - command: subprocess.exec
      params:
        working_dir: mlab-data-api/src
        binary: docker
        args:
          - tag
          - mlab-data-api:latest
          - ${AWS_ECR_DOCKER_TAG}:latest
  "publish docker image":
    - command: subprocess.exec
      params:
        working_dir: mlab-data-api/src
        binary: docker
        args:
          - push
          - ${AWS_ECR_DOCKER_TAG}:latest

tasks:
- name: test
  commands:
    - func: fetch source
    - func: run tests
- name: docker
  commands:
    - func: fetch source
    - func: login to ecr
    - func: build docker image
    - func: tag docker image
    - func: publish docker image

buildvariants:
- name: test
  display_name: run tests
  run_on:
    - ubuntu1804
  tasks:
    - test
- name: docker
  display_name: publish docker image
  run_on:
    - ubuntu1804
  tasks:
    - docker
